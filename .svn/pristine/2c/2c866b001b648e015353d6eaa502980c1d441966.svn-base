<?php
// +----------------------------------------------------------------------
// | APIæŽ§åˆ¶å™¨
// +----------------------------------------------------------------------
// | Copyright (c) 2017--20xxå¹´ æžæœˆç‹—. All rights reserved.
// +----------------------------------------------------------------------
// | File:     api.php
// |
// | Author:   huzhichao@laoyuegou.com
// | Created:  2017-xx-xx
// +----------------------------------------------------------------------
use Phalcon\Translate\Adapter\NativeArray;
//use PHPExcel;

class ApiController extends BaseController 
{
    public $key = 'userlists';

	public function testAction($id = 0) 
	{
        //$redis = new WebRedis();
        $list = $this->redis->read( 'a','l',1);
        var_dump($list);exit;


/*
        $sql = 'select * from cmf_role';
        $res = $this->db->fetchOne($sql);


    	return $this->success('ok', $res);*/
    }


    public function getTranslation( $language = '', $category = '', $is_web )
    {

    	if(empty($language)) {
    		$language = $this->request->getBestLanguage();

    		$language = empty($language) ? 'zh-cn' : $language;
    	}

    	$language = strtolower($language);

    	$translationFile = ROOT_PATH ."/messages/" . $language . "/" . $category . ".php";

    	//print_r($translationFile);exit;

        // Check if we have a translation file for that lang
        if (file_exists($translationFile)) {
            $messages = require $translationFile;
        } else {
            // Fallback to some default
            $messages = require ROOT_PATH . "/messages/zh-cn/.php";
        }

        if($is_web) {
            // Return a translation object
            return new NativeArray(
                [
                    "content" => $messages,
                ]
            );
        }else{
            // Return a array
            return $messages;
        }

        

    	//return $this->success('ok', $language);
    }

    public function indexAction( $language = '', $category = '', $messages = '', $is_web = false )
    {

        $this->t  = $this->getTranslation($language, $category, $is_web);

        //file_put_contents($language. '_' . $category .'.json', json_encode($this->t));

        if($is_web)
            return $this->success('ok', $this->t[$messages]);
        return $this->success('ok', $this->t);

        //print_r($this->lingual);exit;
    }




////////////////////////////////////////ðŸ‘†å‡ä¸ºæµ‹è¯•////////////////////////////////////////////





    /**
    * è¿”å›žMySQLå¯¹åº”æ¸¸æˆçš„å¯¹åº”è¯­è¨€
    * @return {web/json}  {php/.php array}
    * @param  
    * @author huzhichao@laoyuegou.com
    * @link   
    * @date   
    */
    public function getAction( $language = 'zh-cn', $category = 'lol', $is_web = 1 )
    {
        try {

            $LanguageModel = new LanguageModel();

            $result = $LanguageModel->getCategoryLanguage( $language, $category );

            if($is_web) {

                return $result;

                /*$path = "./public/download/" . $category . ".json";

                if(fopen($path, 'w')) {
                    file_put_contents($path, $result);
                    $this->downfile($path, $category, 'json');
                } else {
                    echo 'error';
                }*/

            } else {
                $path = "./public/download/" . $category . ".php";

                $save_array = "<?php\r\n" . var_export(json_decode($result), true);

                if(fopen($path, 'w')) {
                    file_put_contents($path, $save_array);
                    $this->downfile($path, $category , 'php');
                } else {
                    echo 'error';
                }
            }
            
        } catch (Exception $e) {
            return $this->success($e->getMessage());
        }
    }

    private function downfile( $path, $category, $suffix = 'php' )
    {
        Header( "Content-type:  application/octet-stream "); 
        Header( "Accept-Ranges:  bytes "); 
        Header( "Accept-Length: " .filesize($path));
        header( "Content-Disposition:  attachment;  filename= {$category}.{$suffix}"); 
        //echo file_get_contents($path);
        readfile($path); 
    }




    
    

}
